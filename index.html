<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sight-Singing Practice</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/abcjs@6.2.0/dist/abcjs-basic-min.js"></script>
    <style>
        /* Custom styles for the app */
        body {
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
        }
        
        /* Custom ABCJS Staff Styling */
        .abcjs-container svg {
            width: 100%;
            max-width: 100%;
            overflow-x: auto;
        }

        /* NEW: Tuner Bar Transition for Smoothness */
        #compact-tuner-bar {
            transition: left 0.1s ease-out, background-color 0.2s ease-in-out;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-700 min-h-screen">

    <div class="container mx-auto p-4 max-w-4xl"> <main class="bg-white p-4 rounded-lg shadow-md border border-slate-200 mb-6 mt-6">
            <div id="staff-display" class="w-full"></div>
        </main>

        <div class="flex flex-wrap justify-center gap-3 items-center mb-6"> <button id="drone-toggle" class="px-5 py-2 bg-blue-500 text-white font-medium rounded-full shadow hover:bg-blue-600 transition-colors">
                Play Tonic
            </button>
            <button id="settings-toggle" class="px-5 py-2 bg-gray-600 text-white font-medium rounded-full shadow hover:bg-gray-700 transition-colors">
                Settings
            </button>
            
            <div id="compact-tuner-container" class="bg-white p-3 rounded-full shadow border border-slate-200 flex items-center space-x-2">
                <button id="tuner-toggle" class="px-4 py-1.5 bg-green-500 text-white text-sm font-medium rounded-full shadow hover:bg-green-600 transition-colors">
                    Start Tuner
                </button>
                <div id="compact-tuner-display" class="flex items-center space-x-2 hidden">
                    <div id="compact-note-name" class="text-xl font-bold text-slate-800 w-12 text-right">--</div>
                    <div class="relative w-24 h-2 bg-slate-200 rounded-full overflow-hidden">
                        <div class="absolute top-0 left-1/2 h-full w-0.5 bg-slate-500 -translate-x-1/2 z-10"></div>
                        <div id="compact-tuner-bar" class="absolute top-0 h-full w-1 transition-all duration-75" style="left: 50%; transform: translateX(-50%); background-color: #ef4444;"></div>
                    </div>
                    <div id="compact-cents-deviation" class="text-sm text-slate-600 w-10 text-left">--</div>
                </div>
            </div>
            </div>
    </div>

    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50 overflow-y-auto">
        <div class="bg-white w-full max-w-lg p-6 rounded-lg shadow-xl relative my-8">
            <button id="close-modal-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            <h2 class="text-2xl font-bold mb-6 text-slate-800">Exercise Settings</h2>
            
            <form id="settings-form" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="clef-select" class="block text-sm font-medium mb-1">Clef (音部記号 / ключ)</label>
                        <select id="clef-select" class="w-full p-2 border border-slate-300 rounded-lg">
                            <option value="treble" selected>Treble</option>
                            <option value="bass">Bass</option>
                        </select>
                    </div>
                    <div>
                        <label for="key-select" class="block text-sm font-medium mb-1">Key Signature (調号 / ключовий знак)</label>
                        <select id="key-select" class="w-full p-2 border border-slate-300 rounded-lg">
                            </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="time-sig-select" class="block text-sm font-medium mb-1">Time Signature (拍子記号 / розмір)</label>
                        <select id="time-sig-select" class="w-full p-2 border border-slate-300 rounded-lg">
                            <option value="4/4" selected>4/4</option>
                            <option value="3/4">3/4</option>
                            <option value="2/4">2/4</option>
                        </select>
                    </div>
                    <div>
                        <label for="length-input" class="block text-sm font-medium mb-1">Measures (小節 / такт)</label>
                        <input type="number" id="length-input" value="12" min="2" max="16" class="w-full p-2 border border-slate-300 rounded-lg">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-1">Note Durations (音価 / тривалість ноти)</label>
                    <div id="duration-checks" class="flex flex-wrap gap-4 p-2 border border-slate-300 rounded-lg">
                        <label class="flex items-center gap-2">
                            <input type="checkbox" value="1" class="rounded"> Eighths (8分音符)
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" value="2" class="rounded" checked> Quarters (4分音符)
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" value="4" class="rounded"> Halves (2分音符)
                        </label>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-1">Allowed Scale Degrees (音度 / ступінь)</label>
                    <div id="note-selection-checks" class="p-3 border border-slate-300 rounded-lg bg-slate-50 space-y-3">
                        
                        <div>
                            <label class="block text-sm font-medium mb-1 text-slate-700">Natural (自然 / діатонічний)</label>
                            <div class="flex flex-wrap gap-x-4 gap-y-2 p-2 border border-slate-200 rounded-lg">
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" value="C" class="rounded" checked> <span class="font-medium">1</span>
                                </label>
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" value="D" class="rounded" checked> <span class="font-medium">2</span>
                                </label>
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" value="E" class="rounded" checked> <span class="font-medium">3</span>
                                </label>
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" value="F" class="rounded"> <span class="font-medium">4</span>
                                </label>
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" value="G" class="rounded"> <span class="font-medium">5</span>
                                </label>
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" value="A" class="rounded"> <span class="font-medium">6</span>
                                </label>
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" value="B" class="rounded"> <span class="font-medium">7</span>
                                </label>
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" value="c" class="rounded"> <span class="font-medium">8</span>
                                </label>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-1 text-blue-600">Flats (短音 / бемоль)</label>
                            <div class="flex flex-wrap gap-x-4 gap-y-2 p-2 border border-slate-200 rounded-lg">
                                <label class="flex items-center gap-2 text-blue-600">
                                    <input type="checkbox" value="_D" class="rounded text-blue-600"> ♭2
                                </label>
                                <label class="flex items-center gap-2 text-blue-600">
                                    <input type="checkbox" value="_E" class="rounded text-blue-600"> ♭3
                                </label>
                                <label class="flex items-center gap-2 text-blue-600">
                                    <input type="checkbox" value="_G" class="rounded text-blue-600"> ♭5
                                </label>
                                <label class="flex items-center gap-2 text-blue-600">
                                    <input type="checkbox" value="_A" class="rounded text-blue-600"> ♭6
                                </label>
                                <label class="flex items-center gap-2 text-blue-600">
                                    <input type="checkbox" value="_B" class="rounded text-blue-600"> ♭7
                                </label>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium mb-1 text-red-600">Sharps (増音 / дієз)</label>
                            <div class="flex flex-wrap gap-x-4 gap-y-2 p-2 border border-slate-200 rounded-lg">
                                <label class="flex items-center gap-2 text-red-600">
                                    <input type="checkbox" value="^C" class="rounded text-red-600"> ♯1
                                </label>
                                <label class="flex items-center gap-2 text-red-600">
                                    <input type="checkbox" value="^D" class="rounded text-red-600"> ♯2
                                </label>
                                <label class="flex items-center gap-2 text-red-600">
                                    <input type="checkbox" value="^F" class="rounded text-red-600"> ♯4
                                </label>
                                <label class="flex items-center gap-2 text-red-600">
                                    <input type="checkbox" value="^G" class="rounded text-red-600"> ♯5
                                </label>
                                <label class="flex items-center gap-2 text-red-600">
                                    <input type="checkbox" value="^A" class="rounded text-red-600"> ♯6
                                </label>
                            </div>
                        </div>

                    </div>
                </div>
                <div class="pt-4">
                    <button type="button" id="generate-button" class="w-full px-6 py-3 bg-blue-600 text-white font-bold rounded-lg shadow hover:bg-blue-700 transition-colors">
                        Generate Exercise
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        // --- 5.1 State ---
        let audioContext;
        let droneNodes = []; // Will hold our oscillators
        let droneGainNode = null; // Master gain for the pad
        
        // Tuner State
        let micStream = null;
        let analysisFrameId = null;
        let analyserNode = null;
        let audioBuffer = null;
        let isTunerActive = false;
        
        // App settings
        let settings = {
            clef: 'treble',
            key: 'C',
            timeSignature: '4/4',
            durations: [2], // 2=quarter
            allowedNotes: ['C', 'D', 'E'], // Default to 1, 2, 3
            length: 16 // Default to 16
        };

        // Note data for frequency calculation
        const A4 = 440;
        const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        
        const keySignatures = {
            // Key: [abcjs key, tonic frequency (octave 4)]
            'C Major': ['C', 261.63],
            'G Major': ['G', 392.00],
            'D Major': ['D', 293.66],
            'A Major': ['A', 440.00],
            'E Major': ['E', 329.63],
            'B Major': ['B', 493.88],
            'F# Major': ['F#', 369.99],
            'C# Major': ['C#', 277.18],
            'F Major': ['F', 349.23],
            'Bb Major': ['Bb', 466.16],
            'Eb Major': ['Eb', 311.13],
            'Ab Major': ['Ab', 415.30],
            'Db Major': ['Db', 277.18],
            'Gb Major': ['Gb', 369.99],
            'Cb Major': ['Cb', 493.88],
        };

        // --- 5.2 DOM References ---
        const droneToggle = document.getElementById('drone-toggle');
        const settingsToggle = document.getElementById('settings-toggle');
        const settingsModal = document.getElementById('settings-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const generateButton = document.getElementById('generate-button');
        const staffDisplay = document.getElementById('staff-display');

        // NEW: Compact Tuner DOM References
        const tunerToggle = document.getElementById('tuner-toggle');
        const compactTunerDisplay = document.getElementById('compact-tuner-display');
        const compactNoteName = document.getElementById('compact-note-name');
        const compactCentsDeviation = document.getElementById('compact-cents-deviation');
        const compactTunerBar = document.getElementById('compact-tuner-bar');

        // Settings Inputs
        const clefSelect = document.getElementById('clef-select');
        const keySelect = document.getElementById('key-select');
        const timeSigSelect = document.getElementById('time-sig-select');
        const durationChecks = document.getElementById('duration-checks').querySelectorAll('input[type="checkbox"]');
        const lengthInput = document.getElementById('length-input');
        
        const noteSelectionChecks = document.getElementById('note-selection-checks').querySelectorAll('input[type="checkbox"]');


        // --- 5.3 Core Logic (Drone, Notation) ---

        /**
         * Initializes the AudioContext in response to a user gesture.
         */
        function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        /**
         * Populates the key signature select dropdown.
         */
        function populateKeySelect() {
            Object.keys(keySignatures).forEach(keyName => {
                const option = document.createElement('option');
                option.value = keySignatures[keyName][0]; // e.g., 'C'
                option.textContent = keyName;
                if (keyName === 'C Major') {
                    option.selected = true;
                }
                keySelect.appendChild(option);
            });
        }

        /**
         * Reads all values from the settings modal and updates the global `settings` object.
         */
        function updateSettingsFromDOM() {
            settings.clef = clefSelect.value;
            settings.key = keySelect.value;
            settings.timeSignature = timeSigSelect.value;
            settings.length = parseInt(lengthInput.value, 10);
            
            settings.durations = [];
            durationChecks.forEach(check => {
                if (check.checked) {
                    settings.durations.push(parseInt(check.value, 10));
                }
            });
            
            if (settings.durations.length === 0) {
                const quarterCheckbox = Array.from(durationChecks).find(cb => cb.value === '2');
                if (quarterCheckbox) {
                    quarterCheckbox.checked = true;
                    settings.durations.push(2);
                } else if (durationChecks.length > 0) { // Fallback
                    durationChecks[0].checked = true;
                    settings.durations.push(parseInt(durationChecks[0].value, 10));
                }
            }

            settings.allowedNotes = [];
            noteSelectionChecks.forEach(check => {
                if (check.checked) {
                    settings.allowedNotes.push(check.value); 
                }
            });
            
            // Fallback: if none are checked, default to the tonic
            if (settings.allowedNotes.length === 0) {
                const tonicCheckbox = Array.from(noteSelectionChecks).find(cb => cb.value === 'C');
                if (tonicCheckbox) {
                    tonicCheckbox.checked = true;
                    settings.allowedNotes.push('C');
                } else if (noteSelectionChecks.length > 0) {
                    noteSelectionChecks[0].checked = true;
                    settings.allowedNotes.push(noteSelectionChecks[0].value);
                }
            }
        }

        /**
         * Generates a pseudo-random melody string for abcjs.
         */
        function generateMelody() {
            let abcString = `X:1\nT:Sight-Singing Exercise\nM:${settings.timeSignature}\nL:1/8\nK:${settings.key}\n[V:1 clef=${settings.clef}]\n`;
            
            const [beatsPerMeasure, beatUnit] = settings.timeSignature.split('/').map(Number);
            const totalEighthsPerMeasure = (beatsPerMeasure / beatUnit) * 8;
            const totalEighths = totalEighthsPerMeasure * settings.length;

            const availableNotes = settings.allowedNotes;
            
            const durationMap = {
                '1': '1', // Eighth note (1)
                '2': '2', // Quarter note (2)
                '4': '4', // Half note (4)
            };
            const availableDurations = settings.durations.map(d => durationMap[d]);

            let currentEighths = 0;
            let measureCount = 0;
            let melody = [];
            
            let lastNote = 'C';
            if (!availableNotes.includes('C')) {
                lastNote = availableNotes[0];
            }
            
            let startDuration = '2'; // Default to quarter note
            if (availableDurations.includes('2')) {
                startDuration = '2';
            } else {
                startDuration = availableDurations[0]; // or first available
            }

            melody.push(lastNote + startDuration); 
            currentEighths += parseInt(startDuration, 10); 

            if (currentEighths % totalEighthsPerMeasure === 0) {
                measureCount++;
                if (measureCount % 4 === 0 && currentEighths < totalEighths) {
                    melody.push('|\n');
                } else {
                    melody.push('|');
                }
            }


            while (currentEighths < totalEighths) {
                const eighthsInMeasureSoFar = currentEighths % totalEighthsPerMeasure;
                const eighthsLeftInMeasure = totalEighthsPerMeasure - eighthsInMeasureSoFar;
                
                const fittingDurations = availableDurations.filter(d => parseInt(d, 10) <= eighthsLeftInMeasure);

                let nextDurationStr;
                let nextDurationEighths;
                
                if (fittingDurations.length > 0) {
                    nextDurationStr = fittingDurations[Math.floor(Math.random() * fittingDurations.length)];
                    nextDurationEighths = parseInt(nextDurationStr, 10);

                    let nextNote = availableNotes[Math.floor(Math.random() * availableNotes.length)];
                    melody.push(nextNote + nextDurationStr);
                } else {
                    nextDurationEighths = eighthsLeftInMeasure;
                    nextDurationStr = nextDurationEighths.toString();
                    melody.push('z' + nextDurationStr); // 'z' is a rest (休符 / пауза)
                }

                currentEighths += nextDurationEighths;

                if (currentEighths % totalEighthsPerMeasure === 0 && currentEighths < totalEighths) {
                    measureCount++;
                    if (measureCount % 4 === 0 && measureCount < settings.length) { 
                        melody.push('|\n'); 
                    } else {
                        melody.push('|'); 
                    }
                }
            }
            
            melody.push('|]'); // End bar
            return abcString + melody.join(' ');
        }


        /**
         * Renders the notation to the staff display area.
         */
        function renderNotation() {
            try {
                const abcString = generateMelody();
                window.ABCJS.renderAbc(staffDisplay, abcString, { 
                    responsive: "resize",
                    add_classes: true 
                });
            } catch (error) {
                console.error("Error rendering ABCJS notation:", error);
                staffDisplay.innerHTML = `<p class="text-red-500">Error generating notation. Please check settings and try again.</p>`;
            }
        }

        /**
         * Starts the tonic "pad" drone.
         */
        function startDrone() {
            if (droneNodes.length > 0) return; // Already playing
            initAudioContext();
            
            const keyName = Object.keys(keySignatures).find(k => keySignatures[k][0] === settings.key) || 'C Major';
            
            const baseFrequency = keySignatures[keyName][1] / 2.0; // Tonic (主音 / тоніка) frequency
            
            // 1. Create master gain and filter
            droneGainNode = audioContext.createGain();
            const filterNode = audioContext.createBiquadFilter();
            filterNode.type = 'lowpass'; // (ローパスフィルター / фільтр низьких частот)
            filterNode.frequency.setValueAtTime(800, audioContext.currentTime); // Cut off harsh highs
            
            droneGainNode.connect(filterNode).connect(audioContext.destination);

            // 2. Create oscillators
            const detuneValues = [-5, 0, 5]; // Detune (デチューン / розстроювання) in cents
            
            detuneValues.forEach(detune => {
                const osc = audioContext.createOscillator();
                osc.type = 'sawtooth'; // (ノコギリ波 / пилкоподібна хвиля) for a rich sound
                osc.frequency.setValueAtTime(baseFrequency, audioContext.currentTime);
                osc.detune.setValueAtTime(detune, audioContext.currentTime);
                
                osc.connect(droneGainNode); // Connect to the gain node
                osc.start();
                droneNodes.push(osc);
            });

            // 3. Apply Attack (fade-in)
            droneGainNode.gain.setValueAtTime(0, audioContext.currentTime);
            droneGainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.5); // Fade to 10% volume
            
            droneToggle.textContent = 'Stop Tonic';
            droneToggle.classList.replace('bg-blue-500', 'bg-red-500');
            droneToggle.classList.replace('hover:bg-blue-600', 'hover:bg-red-600');
        }

        /**
         * Stops the tonic "pad" drone with a fade-out.
         */
        function stopDrone() {
            if (!droneGainNode) return;
            
            // 1. Apply Release (fade-out)
            const releaseTime = audioContext.currentTime + 1.0; // 1 second fade-out
            droneGainNode.gain.linearRampToValueAtTime(0, releaseTime);
            
            // 2. Stop oscillators after the fade-out is complete
            droneNodes.forEach(osc => {
                osc.stop(releaseTime);
            });
            
            // 3. Clean up
            droneNodes = [];
            droneGainNode = null;
            
            droneToggle.textContent = 'Play Tonic';
            droneToggle.classList.replace('bg-red-500', 'bg-blue-500');
            droneToggle.classList.replace('hover:bg-red-600', 'hover:bg-blue-600');
        }


        // --- 5.4 Pitch Detection Logic (UNCHANGED, except UI updates) ---

        /**
         * Starts the microphone and pitch detection.
         */
        async function startTuner() {
            if (isTunerActive) return;
            initAudioContext();
            
            try {
                micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            } catch (err) {
                console.error("Error getting microphone access:", err);
                alert("Microphone access denied. Please allow access to use the tuner."); // Simple alert for compact mode
                return;
            }
            
            const source = audioContext.createMediaStreamSource(micStream);
            analyserNode = audioContext.createAnalyser();
            analyserNode.fftSize = 4096; // Larger size for better low-frequency resolution
            
            audioBuffer = new Float32Array(analyserNode.fftSize);
            source.connect(analyserNode);
            
            isTunerActive = true;
            runPitchDetection();

            // Update UI for compact tuner
            tunerToggle.textContent = 'Stop Tuner';
            tunerToggle.classList.replace('bg-green-500', 'bg-red-500');
            tunerToggle.classList.replace('hover:bg-green-600', 'hover:bg-red-600');
            compactTunerDisplay.classList.remove('hidden'); // Show tuner info
        }

        /**
         * Stops the microphone and pitch detection.
         */
        function stopTuner() {
            if (!isTunerActive) return;
            
            if (analysisFrameId) {
                cancelAnimationFrame(analysisFrameId);
            }
            if (micStream) {
                micStream.getTracks().forEach(track => track.stop());
            }
            
            micStream = null;
            analyserNode = null;
            audioBuffer = null;
            isTunerActive = false;
            
            // Update UI for compact tuner
            tunerToggle.textContent = 'Start Tuner';
            tunerToggle.classList.replace('bg-red-500', 'bg-green-500');
            tunerToggle.classList.replace('hover:bg-red-600', 'hover:bg-green-600');
            compactTunerDisplay.classList.add('hidden'); // Hide tuner info
            // Reset tuner display on stop
            updateTunerUI('--', 0); 
        }

        /**
         * The main animation loop for detecting and displaying pitch.
         */
        function runPitchDetection() {
            if (!analyserNode) return;
            
            analyserNode.getFloatTimeDomainData(audioBuffer);
            const freq = findFundamentalFreq(audioBuffer, audioContext.sampleRate);
            
            if (freq > 0) {
                const midiNote = getMidiNoteFromFrequency(freq);
                const noteStr = getNoteString(midiNote);
                const cents = getCentsDeviation(freq, midiNote);
                updateTunerUI(noteStr, cents); // Simplified UI call
            } else {
                // No clear pitch, reset UI
                updateTunerUI('--', 0); // Simplified UI call
            }
            
            analysisFrameId = requestAnimationFrame(runPitchDetection);
        }

        /**
         * Updates the compact tuner display elements.
         * Removed freqStr as it's no longer displayed.
         */
        function updateTunerUI(noteStr, centsVal) {
            compactNoteName.textContent = noteStr;
            compactCentsDeviation.textContent = centsVal.toFixed(0);

            // Update bar position
            // Map -50 cents (flat) to 0% left, +50 cents (sharp) to 100% left
            const barPositionPercent = 50 + centsVal; 
            compactTunerBar.style.left = `${Math.max(0, Math.min(100, barPositionPercent))}%`;
            
            // Update bar color
            if (Math.abs(centsVal) < 10) {
                compactTunerBar.style.backgroundColor = '#22c55e'; // green-500
            } else if (Math.abs(centsVal) < 25) {
                compactTunerBar.style.backgroundColor = '#eab308'; // yellow-500
            } else {
                compactTunerBar.style.backgroundColor = '#ef4444'; // red-500
            }
        }

        /**
         * Converts a frequency (Hz) to a MIDI note number.
         */
        function getMidiNoteFromFrequency(freq) {
            return Math.round(12 * (Math.log2(freq / A4)) + 69);
        }

        /**
         * Converts a MIDI note number to its standard frequency (Hz).
         */
        function getFrequencyFromMidiNote(midiNote) {
            return A4 * Math.pow(2, (midiNote - 69) / 12);
        }

        /**
         * Converts a MIDI note number to a note string (e.g., "A4").
         */
        function getNoteString(midiNote) {
            const octave = Math.floor(midiNote / 12) - 1;
            const noteIndex = midiNote % 12;
            return noteNames[noteIndex] + octave;
        }

        /**
         * Calculates the deviation in cents from the nearest perfect note.
         */
        function getCentsDeviation(freq, midiNote) {
            const correctFreq = getFrequencyFromMidiNote(midiNote);
            const cents = 1200 * Math.log2(freq / correctFreq);
            // Clamp between -50 and +50
            return Math.max(-50, Math.min(50, cents));
        }

        /**
         * Finds the fundamental frequency using an autocorrelation method.
         */
        function findFundamentalFreq(buffer, sampleRate) {
            const bufferSize = buffer.length;
            const rms = Math.sqrt(buffer.reduce((acc, val) => acc + val * val, 0) / bufferSize);

            // 1. Check for silence (amplitude threshold)
            if (rms < 0.01) { // Adjusted sensitivity slightly
                return -1;
            }

            // 2. Limit search range for human voice
            const minSamples = Math.floor(sampleRate / 1500); // Max freq: ~1500 Hz
            const maxSamples = Math.floor(sampleRate / 60);  // Min freq: ~60 Hz
            let bestPeriod = 0;
            let bestCorrelation = 0;
            
            let correlation = new Float32Array(bufferSize); // Correctly declare and fill

            // 3. Autocorrelation
            for (let lag = minSamples; lag <= maxSamples; lag++) {
                let sum = 0;
                for (let i = 0; i < bufferSize - lag; i++) {
                    sum += buffer[i] * buffer[i + lag];
                }
                
                let variance = 0;
                for (let i = 0; i < bufferSize - lag; i++) {
                    variance += buffer[i] * buffer[i];
                }
                
                let normalizedSum = sum / Math.sqrt(variance);
                
                correlation[lag] = normalizedSum; // Populate correlation array

                if (normalizedSum > bestCorrelation) {
                    bestCorrelation = normalizedSum;
                    bestPeriod = lag;
                }
            }

            // 4. Check for a clear correlation
            if (bestCorrelation < 0.85) { // Confidence threshold
                return -1;
            }
            
            // 5. Parabolic interpolation for better (sub-sample) peak accuracy
            if (bestPeriod <= minSamples || bestPeriod >= maxSamples - 1 || bestPeriod === 0) {
                return sampleRate / bestPeriod; 
            }
            
            const y1 = correlation[bestPeriod - 1]; 
            const y2 = correlation[bestPeriod];     
            const y3 = correlation[bestPeriod + 1]; 

            const d = (y3 - y1) / (2 * (2 * y2 - y1 - y3));

            if (!isFinite(d)) {
                return sampleRate / bestPeriod; 
            }

            const refinedPeriod = bestPeriod + d;
            return sampleRate / refinedPeriod;
        }


        // --- 5.5 Event Listeners ---
        
        function init() {
            // Populate dynamic content
            populateKeySelect();
            
            // Set initial state from DOM (for default values)
            updateSettingsFromDOM();
            
            // Render default exercise on load
            renderNotation();
            
            // Control Buttons
            droneToggle.addEventListener('click', () => {
                initAudioContext(); 
                if (droneNodes.length > 0) {
                    stopDrone();
                } else {
                    startDrone();
                }
            });
            
            // Tuner Toggle Event Listener
            tunerToggle.addEventListener('click', () => {
                if (isTunerActive) {
                    stopTuner();
                } else {
                    startTuner();
                }
            });

            // Settings Modal
            settingsToggle.addEventListener('click', () => {
                settingsModal.classList.remove('hidden');
            });

            closeModalBtn.addEventListener('click', () => {
                settingsModal.classList.add('hidden');
            });
            
            settingsModal.addEventListener('click', (e) => {
                if (e.target === settingsModal) {
                    settingsModal.classList.add('hidden');
                }
            });

            // Generate Button
            generateButton.addEventListener('click', () => {
                updateSettingsFromDOM();
                renderNotation();
                settingsModal.classList.add('hidden');
                
                // If drone is playing, restart it with the new key
                if (droneNodes.length > 0) {
                    stopDrone();
                    startDrone();
                }
            });
        }
        
        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>